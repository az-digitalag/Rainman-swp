---
title: "Explore half-hourly data"
author: "Jessica Guo"
date: "4/2/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Soil data from RainMan SR

After relating daily mean soil water content and soil water potential, we now focus on the S1-S4 treatment period of 7/13/2020 to 9/30/2020 and examine the half-hourly data

```{r}
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(lubridate)
library(cowplot)
```

## Half-hourly ata exploration

As before, we load in the half-hourly time series data for VWC, which contains VWC and WP. We match VWC and VWP up for the S1-S4 period, including only plots 3_4 and 3_7. 

```{r}
tm <- data.frame(Period = c("Winter 2020", "Premonsoon", "S1-S4", "Winter 2021"),
                     st = c(as.Date("2019-11-01"), as.Date("2020-05-01"), 
                            as.Date("2020-07-13"), as.Date("2020-10-01")),
                     en = c(as.Date("2020-04-30"), as.Date("2020-07-12"),
                            as.Date("2020-09-30"), as.Date("2021-03-06")))
tm$Period <- factor(tm$Period, levels = c("Winter 2020", "Premonsoon", "S1-S4", "Winter 2021"))

WC <- read.csv("../data/Halfhourly_VWC_Weather_030621.csv") %>%
  dplyr::select(-X, -T_inside, -RH_inside, -T_outside, -RH_outside) %>%
  mutate(TIMESTAMP = as.POSIXct(TIMESTAMP),
         date = as.Date(TIMESTAMP)) %>%
  rename(dt = TIMESTAMP) %>%
  tidyr::pivot_longer(!c(dt, date), 
                      names_to = c("Variable", "Plot", "Depth", "House"), 
                      names_pattern = "(.*)_P(.*)_(.*)_H(.*)") %>%
  mutate(House = factor(as.numeric(House)),
         Depth = factor(as.numeric(Depth)),
         Plot = factor(as.numeric(Plot)),
         ID = paste0(Variable, "_P", Plot, "_", Depth, "_H", House)) %>%
  arrange(ID, dt) %>%
  dplyr::select(-ID) %>%
  filter(House == "3" & Plot %in% c("4", "7")) %>%
  tidyr::drop_na() %>%
  tidyr::pivot_wider(names_from = "Variable", values_from = "value") %>%
  mutate(Period = case_when(date <= tm$en[1] & date >= tm$st[1] ~ tm$Period[1],
                            date <= tm$en[2] & date >= tm$st[2] ~ tm$Period[2],
                            date <= tm$en[3] & date >= tm$st[3] ~ tm$Period[3],
                            date <= tm$en[4] & date >= tm$st[4] ~ tm$Period[4]),
         depth = Depth,
         Depth = case_when(depth == 1 ~ "0-12 cm",
                           depth == 2 ~ "25 cm",
                           depth == 3 ~ "75 cm"),
         year = year(dt),
         week = isoweek(dt),
         year_week = paste0(year, "_", week))

```

Half-hourly data plots
```{r, echo = FALSE, warning = FALSE}
cols <- brewer.pal(11, "Spectral")
yws <- unique(WC$year_week)
for(yw in yws) {
  # Subset data by week
    sub <- WC %>%
      filter(year_week == yw)
    Year <- unique(sub$year)
    
    # Double axis plot
    fig1 <- ggplot(sub, aes(x = dt)) +
      geom_point(aes(y = SWP/1000, color = "SWP (MPa)"), size = 0.5) +
      geom_point(aes(y = VWC*10-2, color = "VWC"), size = 0.5) +
      facet_grid(rows = vars(Depth), cols = vars(Plot), scales = "free_y") +
      scale_y_continuous(sec.axis = 
                           sec_axis(~./10 + 0.2,
                                    name = expression(paste(Theta, " (", m^3, " ", m^-3, ")")))) +
      scale_color_manual(values = cols[c(2, 10)]) +
      labs(y = expression(paste(Psi, " (MPa)")), x = "", title = Year) +
      theme_bw(base_size = 12) +
      theme(axis.title.y.left = element_text(color = cols[2]),
            axis.title.y.right = element_text(color = cols[10])) +
      guides(color = FALSE)
    
    fig2 <- ggplot(sub) +
      geom_point(aes(x = VWC, y = SWP/1000, color = Depth), size = 0.5) +
      facet_wrap(~Plot, ncol = 2) +
      scale_color_manual(values = cols[c(3, 7, 9)]) +
      labs(y = expression(paste(Psi, " (MPa)")), 
           x = expression(paste(Theta, " (", m^3, " ", m^-3, ")"))) +
      theme_bw(base_size = 12) +
      guides(color = FALSE)
    
    jpeg(paste0("../plots/weekly/", yw, ".jpg"), height = 6, width = 6, 
         units = "in", res = 600)
    plot_grid(fig1, fig2, nrow = 2, rel_heights = c(2, 1))
    dev.off()
}
```